# Under the hood: networking

```
# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 16436 qdisc noqueue state UNKNOWN
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether bc:76:4e:20:0e:f0 brd ff:ff:ff:ff:ff:ff
    inet 162.209.109.210/24 brd 162.209.109.255 scope global eth0
    inet6 2001:4802:7800:2:1b1e:746f:ff20:ef0/64 scope global
       valid_lft forever preferred_lft forever
    inet6 fe80::be76:4eff:fe20:ef0/64 scope link
       valid_lft forever preferred_lft forever
3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether bc:76:4e:20:10:7e brd ff:ff:ff:ff:ff:ff
    inet 10.176.67.104/18 brd 10.176.127.255 scope global eth1
    inet6 fe80::be76:4eff:fe20:107e/64 scope link
       valid_lft forever preferred_lft forever
4: virbr0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN
    link/ether ea:25:5c:df:4a:93 brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
7: br-int: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN
    link/ether 96:af:a1:ed:91:4b brd ff:ff:ff:ff:ff:ff
8: br-ex: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN
    link/ether ca:17:c0:56:68:4a brd ff:ff:ff:ff:ff:ff
    inet 172.24.4.225/28 scope global br-ex
    inet6 fe80::c817:c0ff:fe56:684a/64 scope link
       valid_lft forever preferred_lft forever
14: qbre011294d-3a: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP
    link/ether 2a:7a:19:b1:31:d4 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::14f8:83ff:fe28:fa28/64 scope link
       valid_lft forever preferred_lft forever
15: qvoe011294d-3a: <BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether a2:e4:a9:cd:23:f1 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::a0e4:a9ff:fecd:23f1/64 scope link
       valid_lft forever preferred_lft forever
16: qvbe011294d-3a: <BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master qbre011294d-3a state UP qlen 1000
    link/ether 2a:7a:19:b1:31:d4 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::287a:19ff:feb1:31d4/64 scope link
       valid_lft forever preferred_lft forever
17: tape011294d-3a: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master qbre011294d-3a state UNKNOWN qlen 500
    link/ether fe:16:3e:19:2a:a3 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::fc16:3eff:fe19:2aa3/64 scope link
       valid_lft forever preferred_lft forever
```


```
# ip netns list
qrouter-00b225a5-0c1f-4d67-818c-ef6a8fa6a188
qdhcp-364f48c0-7755-4cd6-8cec-ed828e337453
```

```
# ip netns exec qrouter-00b225a5-0c1f-4d67-818c-ef6a8fa6a188 ip a
11: lo: <LOOPBACK,UP,LOWER_UP> mtu 16436 qdisc noqueue state UNKNOWN
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
12: qr-249736b8-1c: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN
    link/ether fa:16:3e:1f:3a:c4 brd ff:ff:ff:ff:ff:ff
    inet 10.0.0.1/24 brd 10.0.0.255 scope global qr-249736b8-1c
    inet6 fe80::f816:3eff:fe1f:3ac4/64 scope link
       valid_lft forever preferred_lft forever
13: qg-47dc9963-6a: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN
    link/ether fa:16:3e:d9:23:1c brd ff:ff:ff:ff:ff:ff
    inet 172.24.4.226/28 brd 172.24.4.239 scope global qg-47dc9963-6a
    inet 172.24.4.227/32 brd 172.24.4.227 scope global qg-47dc9963-6a
    inet6 fe80::f816:3eff:fed9:231c/64 scope link
       valid_lft forever preferred_lft forever
```


```
# ip netns exec qdhcp-364f48c0-7755-4cd6-8cec-ed828e337453 ip a
9: tap931c91d9-75: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN
    link/ether fa:16:3e:23:34:73 brd ff:ff:ff:ff:ff:ff
    inet 10.0.0.2/24 brd 10.0.0.255 scope global tap931c91d9-75
    inet6 fe80::f816:3eff:fe23:3473/64 scope link
       valid_lft forever preferred_lft forever
10: lo: <LOOPBACK,UP,LOWER_UP> mtu 16436 qdisc noqueue state UNKNOWN
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
```


```
# iptables-save
# Generated by iptables-save v1.4.12 on Wed Nov  6 01:15:53 2013
*nat
:PREROUTING ACCEPT [328:21296]
:INPUT ACCEPT [269:16707]
:OUTPUT ACCEPT [5579:337832]
:POSTROUTING ACCEPT [5606:339997]
:neutron-openvswi-OUTPUT - [0:0]
:neutron-openvswi-POSTROUTING - [0:0]
:neutron-openvswi-PREROUTING - [0:0]
:neutron-openvswi-float-snat - [0:0]
:neutron-openvswi-snat - [0:0]
:neutron-postrouting-bottom - [0:0]
:nova-api-OUTPUT - [0:0]
:nova-api-POSTROUTING - [0:0]
:nova-api-PREROUTING - [0:0]
:nova-api-float-snat - [0:0]
:nova-api-snat - [0:0]
:nova-compute-OUTPUT - [0:0]
:nova-compute-POSTROUTING - [0:0]
:nova-compute-PREROUTING - [0:0]
:nova-compute-float-snat - [0:0]
:nova-compute-snat - [0:0]
:nova-postrouting-bottom - [0:0]
-A PREROUTING -j nova-compute-PREROUTING
-A PREROUTING -j neutron-openvswi-PREROUTING
-A PREROUTING -j nova-api-PREROUTING
-A OUTPUT -j nova-compute-OUTPUT
-A OUTPUT -j neutron-openvswi-OUTPUT
-A OUTPUT -j nova-api-OUTPUT
-A POSTROUTING -j nova-compute-POSTROUTING
-A POSTROUTING -j neutron-openvswi-POSTROUTING
-A POSTROUTING -j neutron-postrouting-bottom
-A POSTROUTING -j nova-api-POSTROUTING
-A POSTROUTING -j nova-postrouting-bottom
-A POSTROUTING -s 192.168.122.0/24 ! -d 192.168.122.0/24 -p tcp -j MASQUERADE --to-ports 1024-65535
-A POSTROUTING -s 192.168.122.0/24 ! -d 192.168.122.0/24 -p udp -j MASQUERADE --to-ports 1024-65535
-A POSTROUTING -s 192.168.122.0/24 ! -d 192.168.122.0/24 -j MASQUERADE
-A neutron-openvswi-snat -j neutron-openvswi-float-snat
-A neutron-postrouting-bottom -j neutron-openvswi-snat
-A nova-api-snat -j nova-api-float-snat
-A nova-compute-snat -j nova-compute-float-snat
-A nova-postrouting-bottom -j nova-compute-snat
-A nova-postrouting-bottom -j nova-api-snat
COMMIT
# Completed on Wed Nov  6 01:15:53 2013
# Generated by iptables-save v1.4.12 on Wed Nov  6 01:15:53 2013
*mangle
:PREROUTING ACCEPT [1368926:632822826]
:INPUT ACCEPT [1368675:632801500]
:FORWARD ACCEPT [255:22582]
:OUTPUT ACCEPT [1352262:603935528]
:POSTROUTING ACCEPT [1352485:603955686]
:nova-api-POSTROUTING - [0:0]
:nova-compute-POSTROUTING - [0:0]
-A POSTROUTING -j nova-compute-POSTROUTING
-A POSTROUTING -j nova-api-POSTROUTING
-A POSTROUTING -o virbr0 -p udp -m udp --dport 68 -j CHECKSUM --checksum-fill
COMMIT
# Completed on Wed Nov  6 01:15:53 2013
# Generated by iptables-save v1.4.12 on Wed Nov  6 01:15:53 2013
*filter
:INPUT ACCEPT [1368579:632790718]
:FORWARD ACCEPT [139:10803]
:OUTPUT ACCEPT [1352252:603934813]
:neutron-filter-top - [0:0]
:neutron-openvswi-FORWARD - [0:0]
:neutron-openvswi-INPUT - [0:0]
:neutron-openvswi-OUTPUT - [0:0]
:neutron-openvswi-local - [0:0]
:neutron-openvswi-sg-chain - [0:0]
:neutron-openvswi-sg-fallback - [0:0]
:nova-api-FORWARD - [0:0]
:nova-api-INPUT - [0:0]
:nova-api-OUTPUT - [0:0]
:nova-api-local - [0:0]
:nova-compute-FORWARD - [0:0]
:nova-compute-INPUT - [0:0]
:nova-compute-OUTPUT - [0:0]
:nova-compute-inst-1 - [0:0]
:nova-compute-local - [0:0]
:nova-compute-provider - [0:0]
:nova-compute-sg-fallback - [0:0]
:nova-filter-top - [0:0]
-A INPUT -j nova-compute-INPUT
-A INPUT -j neutron-openvswi-INPUT
-A INPUT -j nova-api-INPUT
-A INPUT -i virbr0 -p udp -m udp --dport 53 -j ACCEPT
-A INPUT -i virbr0 -p tcp -m tcp --dport 53 -j ACCEPT
-A INPUT -i virbr0 -p udp -m udp --dport 67 -j ACCEPT
-A INPUT -i virbr0 -p tcp -m tcp --dport 67 -j ACCEPT
-A INPUT -p gre -j ACCEPT
-A FORWARD -j nova-filter-top
-A FORWARD -j nova-compute-FORWARD
-A FORWARD -j neutron-filter-top
-A FORWARD -j neutron-openvswi-FORWARD
-A FORWARD -j nova-api-FORWARD
-A FORWARD -d 192.168.122.0/24 -o virbr0 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -s 192.168.122.0/24 -i virbr0 -j ACCEPT
-A FORWARD -i virbr0 -o virbr0 -j ACCEPT
-A FORWARD -o virbr0 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -i virbr0 -j REJECT --reject-with icmp-port-unreachable
-A OUTPUT -j nova-filter-top
-A OUTPUT -j nova-compute-OUTPUT
-A OUTPUT -j neutron-filter-top
-A OUTPUT -j neutron-openvswi-OUTPUT
-A OUTPUT -j nova-api-OUTPUT
-A neutron-filter-top -j neutron-openvswi-local
-A neutron-openvswi-sg-fallback -j DROP
-A nova-api-INPUT -d 162.209.109.210/32 -p tcp -m tcp --dport 8775 -j ACCEPT
-A nova-compute-FORWARD -s 0.0.0.0/32 -d 255.255.255.255/32 -p udp -m udp --sport 68 --dport 67 -j ACCEPT
-A nova-compute-INPUT -s 0.0.0.0/32 -d 255.255.255.255/32 -p udp -m udp --sport 68 --dport 67 -j ACCEPT
-A nova-compute-inst-1 -m state --state INVALID -j DROP
-A nova-compute-inst-1 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A nova-compute-inst-1 -j nova-compute-provider
-A nova-compute-inst-1 -s 10.0.0.2/32 -p udp -m udp --sport 67 --dport 68 -j ACCEPT
-A nova-compute-inst-1 -s 10.0.0.0/24 -j ACCEPT
-A nova-compute-inst-1 -j nova-compute-sg-fallback
-A nova-compute-local -d 10.0.0.3/32 -j nova-compute-inst-1
-A nova-compute-sg-fallback -j DROP
-A nova-filter-top -j nova-compute-local
-A nova-filter-top -j nova-api-local
COMMIT
# Completed on Wed Nov  6 01:15:53 2013
```

